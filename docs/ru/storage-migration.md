# Руководство по миграции на хранилище MySQL

Это руководство помогает администраторам обновить существующую установку SphereServer 0.51x до переработанного стека хранения на MySQL. Новый путь выполнения вводит явный фасад хранения, менеджер подключений с пулом и логикой повторных попыток, а также менеджер схемы, централизующий миграции.

## Что нового?

- **Фасад хранения (`MySqlStorageService`)** — оркестрирует импорт аккаунтов, сохранения мира и вызовы репозиториев. Остальные подсистемы взаимодействуют с MySQL только через этот фасад.
- **Менеджер подключений** — нормализует кодировки, учитывает политику авто-переподключения в `CServerMySQLConfig` и поддерживает пул активных подключений, чтобы сохранения могли безопасно переиспользовать дескрипторы.
- **Слой репозиториев** — консолидирует SQL для аккаунтов, объектов мира, таймеров и страниц GM. Каждый репозиторий владеет своими подготовленными выражениями, что уменьшает дублирование и улучшает отчётность об ошибках.
- **Менеджер схемы** — применяет миграции до версии схемы **5**, расширяет устаревшие таблицы при добавлении новых столбцов и фиксирует статус сохранений мира в специальных строках `<prefix>schema_version`.

Если раньше вы ссылались на `CWorldStorageMySQL.cpp`, вся эта логика теперь распределена между `GraySvr/MySqlStorageService.cpp`, `GraySvr/Storage/MySql/ConnectionManager.*` и `GraySvr/Storage/Schema/SchemaManager.*`.

## Контрольный список конфигурации

1. Проверьте раздел `[SPHERE]` в `spheredef.ini`:
   - `MYSQL`, `MYSQLHOST`, `MYSQLPORT`, `MYSQLUSER`, `MYSQLPASS`, `MYSQLDB` и `MYSQLPREFIX` по-прежнему определяют, как сервер подключается к базе данных.
   - `MYSQLCHARSET` теперь напрямую передаётся в менеджер подключений. Можно дополнительно указать сортировку (например, `utf8mb4 utf8mb4_unicode_ci`), и менеджер автоматически определит пару «кодировка/сортировка».
   - Временные каталоги дампов больше не используются. Уберите из сценариев развёртывания заполнение `MYSQLTEMP` и подготовку вспомогательных скриптов — сервис сразу пишет снимки в `WORLDSAVE`.
2. Расширенное поведение подключений регулируется полями `CServerMySQLConfig`:
   - `m_fAutoReconnect` (по умолчанию `true`)
   - `m_iReconnectTries` (по умолчанию 3 попытки)
   - `m_iReconnectDelay` (по умолчанию 5 секунд)
   Стандартная конфигурация оставляет эти значения без изменений; корректируйте их в коде или инструментах развёртывания при необходимости.
3. Системы сборки всё ещё могут переопределять пути к заголовкам и библиотекам через переменные окружения `MYSQL_INCLUDE_DIR` и `MYSQL_LIB_DIR`. Их подхватывают проекты Visual Studio и make-файлы.

## Шаги перед обновлением

1. **Создайте резервную копию базы данных и старых файлов сохранений.** Выгрузите схему MySQL и сохраните копии `sphereworld.scp`, `sphereaccu.scp` и других пользовательских скриптов.
2. **Обновите двоичные файлы.** Соберите или загрузите релиз, включающий новый фасад хранения.
3. **Проверьте конфигурацию.** Убедитесь, что ключи выше заполнены корректно, а у пользователя базы данных остаются права на создание таблиц и выполнение миграций.
4. **Запланируйте простой.** Первой загрузке после обновления требуется запуск менеджера схемы, который может выполнять `ALTER TABLE`. Назначьте окно обслуживания для боевых шардов.

## Процесс миграции

1. Запустите сервер MySQL и убедитесь, что можно подключиться с учётными данными из `spheredef.ini`.
2. Стартуйте обновлённый бинарник SphereServer. При инициализации менеджер подключений формирует пул, а `SchemaManager::EnsureSchema` мигрирует базу до актуальной ревизии.
3. Если файлы учётных записей из наследия ещё присутствуют, фасад импортирует их один раз и установит `<prefix>schema_version`.`id = 2` в состояние «завершено».
4. Выполните сохранение мира (`SAVE 0`) или дождитесь фонового сохранения. Репозитории запишут таблицы `world_objects`, `world_object_data` и связанные данные с помощью подготовленных выражений.
   - Существующие установки, где ранее использовался столбец `type` в `<prefix>world_object_relations`, мигрируются автоматически. Менеджер схемы переименовывает старый столбец в `relation`, чтобы данные продолжали загружаться до первого нового сохранения.
   - В старых таблицах `world_savepoints` столбец `save_reason` переименовывается в `label`, а также добавляется поле `objects_count`, чтобы метаданные снимков записывались без ошибок.
5. Проверьте статус миграций:

   ```sql
   SELECT id, version FROM `<prefix>schema_version` ORDER BY id;
   ```

   - `id = 1` должно быть равно `4`.
   - `id = 2` становится `1` после завершения импорта наследия.
   - `id = 3` увеличивается при каждом сохранении.
   - `id = 4` показывает, завершилось ли последнее сохранение успешно.

6. Изучите логи сервера. Все ошибки подключения выводятся до того, как сервер вернётся к устаревшему файловому загрузчику.

## Советы после обновления

- Держите под рукой `docs/mysql-schema.sql` и `docs/database-schema.md`: они отражают рабочую схему и обновляются вместе с миграциями.
- Используйте чек-лист `docs/storage-migration.md` при каждом развёртывании новой сборки, чтобы не забыть проверить конфигурацию и состояние схемы.
- При расширении схемы добавляйте новую миграцию в `SchemaManager::ApplyMigration` и документируйте изменения перед выкладкой.

Переход на переработанный слой хранения обеспечивает более чёткое разделение ответственности, упрощает развитие схемы и делает сохранения мира предсказуемыми. Потратьте время на разовую проверку конфигурации, и далее новая инфраструктура возьмёт заботы на себя.
