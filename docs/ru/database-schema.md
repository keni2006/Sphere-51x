# Архитектура и схема хранения MySQL

SphereServer 0.51x поставляется с интегрированным уровнем хранения MySQL, который заменяет большую часть устаревших файлов `*.scp`. Реализация разбита на специализированные модули, разделяющие управление подключениями, эволюцию схемы и логику доступа к данным. В этом документе описаны эти модули и приведена детализация таблиц, создаваемых встроенными миграциями.

## Обзор модулей

### Фасад хранения (`GraySvr/MySqlStorageService.*`)

`MySqlStorageService` — это высокоуровневый API, предоставляемый остальной части сервера. Он владеет описанными ниже компонентами и предлагает вспомогательные функции, используемые по всему коду (например, `UniversalRecord` для произвольных вставок/обновлений и интеграцию с `DirtyQueueProcessor` для отложенных сохранений мира). Фасад является единственной точкой входа для подсистем, которым нужно выполнять SQL, ставить объекты мира в очередь на сохранение или читать конфигурацию.

### Менеджер подключений (`GraySvr/Storage/MySql/ConnectionManager.*`)

Менеджер подключений преобразует `CServerMySQLConfig` в готовый пул подключений:

- Проверяет и нормализует пары «кодировка/сортировка», вычисляя разумные значения по умолчанию (используется `utf8mb4`, если кодировка не задана).
- Управляет повторными попытками и задержками при включённом автоматическом переподключении. Поведение задаётся ключами `MYSQL*` в `spheredef.ini` (хост, порт, база, учётные данные, префикс и кодировка), а также флагами переподключения из `CServerMySQLConfig` (`m_fAutoReconnect`, `m_iReconnectTries`, `m_iReconnectDelay`).
- Предоставляет ограниченный доступ к подключениям пула (`MySqlConnectionPool`) и отслеживает явные транзакции, чтобы сложные операции сохранения могли использовать один и тот же дескриптор.
- Экспортирует эффективную кодировку/сортировку таблиц, чтобы генераторы DDL могли подставлять правильные суффиксы при создании новых таблиц.

### Слой репозиториев (`Storage::Repository`)

Чтобы SQL-текст находился рядом с данными, которыми он управляет, сервис формирует иерархию репозиториев внутри `MySqlStorageService.cpp`:

- `PreparedStatementRepository` — тонкая обёртка над подготовленными выражениями. Централизует обработку ошибок, связывание параметров и получение подключений из пула.
- `WorldObjectMetaRepository`, `WorldObjectDataRepository`, `WorldObjectComponentRepository` и `WorldObjectRelationRepository` сопоставляют таблицы сохранений мира со структурами C++. Они отвечают за генерацию `INSERT ... ON DUPLICATE KEY UPDATE`, разбор динамических данных TAG/VAR и удаление осиротевших строк.
- Дополнительные репозитории следуют той же схеме для страниц GM, таймеров, метаданных секторов и других подсистем по мере их миграции в SQL.

Разработчикам, добавляющим новые таблицы, следует придерживаться этой структуры: создать репозиторий, наследующий `PreparedStatementRepository`, определить SQL-выражения в конструкторе и предоставить типизированные методы, принимающие простые структуры записей.

### Менеджер схемы (`GraySvr/Storage/Schema/SchemaManager.*`)

Поддержка схемы реализована в `Storage::Schema::SchemaManager`. Этот менеджер выполняет цепочку миграций при запуске и содержит вспомогательные процедуры для ведения служебных данных:

- Убеждается, что `<prefix>schema_version` существует, и заполняет строки для отслеживания метаданных.
- Применяет инкрементальные миграции (`ApplyMigration_0_1`, `_1_2`, `_2_3`, `_3_4`, …) до достижения текущей ревизии (`CURRENT_SCHEMA_VERSION`).
- Расширяет существующие таблицы с помощью процедур `Ensure*Columns`. Логика проверяет наличие столбцов перед выполнением `ALTER TABLE`, делая повторные запуски идемпотентными.
- Предоставляет методы для чтения/обновления состояния импорта наследия, счётчика сохранений мира и признака «последнее сохранение завершено», который использует подсистема сохранений.

## Внесение изменений в схему

1. Обновите `CURRENT_SCHEMA_VERSION` в `Storage/Schema/SchemaManager.cpp` и добавьте соответствующую ветку в `SchemaManager::ApplyMigration`.
2. Реализуйте новую функцию `ApplyMigration_X_Y`, используя вспомогательные методы фасада для генерации операторов `CREATE TABLE` / `ALTER TABLE`. Предпочитайте `storage.GetPrefixedTableName()` и `storage.GetDefaultTableCollationSuffix()`, чтобы сохранить единообразие правил префиксов и кодировок.
3. Если миграция добавляет столбцы в существующие таблицы, вызовите `EnsureColumnExists` (или следуйте шаблону функций `Ensure*Columns`), чтобы избежать повторного применения изменений.
4. Обновите документацию: этот файл (`docs/database-schema.md`) и пример дампа `docs/mysql-schema.sql`, чтобы они соответствовали исполняемым миграциям.
5. Обновите тесты или скрипты развёртывания, которые проверяют версию схемы.

Помните, что миграции выполняются внутри фасада хранения с открытым подключением, управляемым менеджером подключений, поэтому можно свободно выполнять DDL и DML через `storage.ExecuteQuery()` / `storage.Query()`.

## Справочник по схеме

Текущая версия схемы — **5**. Ниже имена таблиц указаны без необязательного префикса, задаваемого параметром `MYSQLPREFIX`.

### `schema_version`

Отслеживает миграции и рабочие метаданные. Таблица заполняется менеджером схемы.

| `id` | Назначение | Типичные значения |
| ---- | ---------- | ----------------- |
| 1 | Версия схемы (`CURRENT_SCHEMA_VERSION`). | `5` |
| 2 | Флаг импорта учётных записей из наследия (`0` — ожидает, `1` — завершён). | `0` или `1` |
| 3 | Счётчик сохранений мира (инкрементируется после каждого успешного сохранения). | `0+` |
| 4 | Флаг завершения сохранения (`0` — прервано, `1` — успешно). | `0` или `1` |

### Управление аккаунтами

`accounts`
: Основная запись учётной записи Sphere. Хранит учётные данные, уровни привилегий, метаданные чата/почты и временные метки. Индексы настроены на автоинкрементный первичный ключ и уникальное поле `name`.

`account_emails`
: Очередь запланированных писем (активация, предупреждения). Использует составной первичный ключ `(account_id, sequence)` и каскадный внешний ключ на `accounts`.

### Промежуточный импорт наследия

`characters`
: Минимальное представление импортированных персонажей. Содержит позиционные данные и связь с `accounts`. Используется только во время миграции файловых сохранений.

`items`
: Временное хранилище сериализованных предметов при импорте. Поддерживает внешние ключи на `items.uid` (для контейнеров) и `characters.uid` (для отслеживания владельцев).

`item_props`
: Пары «имя/значение» свойств предметов, захваченных во время импорта. Составной первичный ключ `(item_uid, prop)` и каскадное удаление при удалении записей из `items`.

### Рабочие таблицы

`sectors`
: Переопределения параметров секторов мира (освещение, дождь, холод) для дополнительных игровых функций. Счётчики хранятся в беззнаковых столбцах, необязательные параметры допускают `NULL`.

`gm_pages`
: Запросы помощи, отправленные игроками ГМ. Содержат имя аккаунта, причину, временные метки и координаты. При необходимости расширяются менеджером схемы.

`servers`
: Список шарда для классического списка серверов. Содержит сетевые метаданные, контактную информацию, сведения о локализации и статистику устаревания записей.

`timers`
: Вспомогательные таймеры, поддерживающие запланированные операции из классических скриптов. Каждая строка ссылается на сохранённый объект мира через `character_uid` или `item_uid`, оба указывают на `<prefix>world_objects`.`uid`. Столбец `expires_at` хранит оставшиеся тики мира (1 тик = 100 мс) до срабатывания таймера, а `type` различает таймеры персонажей (`1`) и предметов (`2`). Скриптовый движок может сохранять дополнительные данные в `data` для будущих расширений.

### Сохранения мира (`schema` ≥ 3, текущая версия 5)

`world_objects`
: Метаданные каждого сохранённого объекта (персонажи и предметы). Хранят базовый тип/подтип, необязательное отображаемое имя, ссылки на владельцев и кэшированные данные о местоположении/контейнере. Индексируется по владельцам и контейнерам для ускорения синхронизации изменений.

`world_object_data`
: Сериализованное состояние объекта (скриптовые данные), индексируется по `object_uid`. Содержит контрольную сумму для обнаружения расхождений.

`world_object_components`
: Нормализованное представление динамических скриптовых данных (свойства в стиле TAG/VAR). Составной первичный ключ `(object_uid, component, name, sequence)` сохраняет порядок повторяющихся тегов.

`world_object_relations`
: Родительские/дочерние связи (экипировка, вложенные контейнеры). Составной первичный ключ `(parent_uid, child_uid, relation, sequence)` и индекс по `child_uid` для ускорения обратных запросов.

`world_savepoints`
: Таблица учёта ручных контрольных точек сохранений. Содержит метку, временную метку, количество объектов и контрольную сумму.

`world_object_audit`
: Необязательная таблица истории, фиксирующая снимки объектов до/после изменений вместе с типом изменения и временем.

## Дополнительные материалы

- `docs/mysql-schema.sql` — пример дампа, отражающий миграции.
- `docs/storage-migration.md` — чек-лист обновления конфигурации и развёртывания.
- `GraySvr/Storage/Schema/SchemaManager.*` — эталонная реализация миграций.
- `GraySvr/MySqlStorageService.cpp` — пример реализации репозиториев и процессов сохранения.
