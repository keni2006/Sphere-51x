# Экспорт снимков мира MySQL

## Обзор
- SphereServer 0.51x создаёт полный снимок мира в MySQL каждый раз, когда основной процесс сохранения завершает фиксацию данных в рабочих таблицах.
- Метод `CWorld::FinalizeStorageSave()` ставит задачу через `MySqlStorageService::ScheduleWorldSnapshot()`, поэтому основное сохранение завершается сразу, а копирование выполняется в фоновом потоке по мере его доступности.
- Если очередь занята, сервер выдаёт предупреждение и выполняет снимок синхронно; рабочие таблицы остаются доступными для записи, потому что выполняются только `SELECT`-запросы.

## Когда запускаются снимки
- Снимки создаются сразу после фиксации транзакции сохранения и увеличения счётчика сохранений. Метка по умолчанию — `"World save #<n>"`, где `<n>` — текущее значение счётчика.
- Метка времени округляется вниз до настроенного интервала `SAVEPERIOD`, чтобы регулярные сохранения использовали стабильные имена каталогов, даже если запуск сдвигается на несколько секунд.
- Администраторы могут инициировать ручные сохранения; вспомогательный метод применяет ту же логику меток и папок, поэтому внеплановые сохранения тоже получают каталог снимка.

## Расположение файлов
- Параметр `WORLDSAVE` в `spheredef.ini` указывает директорию, куда сервер сохраняет плоские файлы и MySQL-снимки. При первом запуске снимков внутри неё создаётся подпапка `mysqlsnapshots/`.
- Каждый снимок попадает в `WORLDSAVE/mysqlsnapshots/<timestamp_or_label>/`. Имя содержит выровненную метку времени (`YYYYMMDD_HHMMSS`) и, при необходимости, очищенную версию пользовательской метки (например, `20240314_210000_World_save_12`).
- Выгрузка идёт напрямую в этот каталог; временные рабочие папки и очистка вспомогательных скриптов больше не требуются.
- Процесс Sphere должен иметь права на создание папок и запись файлов в каталоге `WORLDSAVE`. Ошибки доступа фиксируются в логе и прерывают создание снимка.

## Содержимое каталога
Внутри каталога создаётся набор SQL-дампов и файл метаданных:

| Файл | Содержимое |
| ---- | ---------- |
| `world_objects.sql` | `DROP TABLE`, `CREATE TABLE` и `INSERT` для `<prefix>world_objects`. |
| `world_object_data.sql` | Полный дамп `<prefix>world_object_data`. |
| `world_object_components.sql` | Полный дамп `<prefix>world_object_components`. |
| `world_object_relations.sql` | Полный дамп `<prefix>world_object_relations`. |
| `world_object_audit.sql` | Полный дамп `<prefix>world_object_audit`. |
| `gm_pages.sql` | Полный дамп `<prefix>gm_pages`. |
| `servers.sql` | Полный дамп `<prefix>servers`. |
| `sectors.sql` | Полный дамп `<prefix>sectors`. |
| `metadata.txt` | Пары ключ/значение: метка, время создания, количество объектов, период сохранения (в секундах) и полный путь до каталога. |

Все SQL-файлы включают определение таблицы, полученное через `SHOW CREATE TABLE`, поэтому их можно восстановить на чистой базе без дополнительных миграций.

## Учёт в базе данных
- Транзакция снимка добавляет строку в `<prefix>world_savepoints`, используя сгенерированные метку, время и число объектов. Это повторяет прежнюю модель, в которой метаданные сохранений фиксировались непосредственно в MySQL.
- Строка с метаданными создаётся, даже если данные находятся на диске, что позволяет операторам отслеживать время окончания последнего снимка и количество сохранённых объектов.

## Обработка ошибок
- Любые сбои при создании каталогов, потоковой выгрузке или записи метаданных прерывают процесс и записывают ошибку в канал логирования сохранений.
- Основное сохранение мира остаётся зафиксированным; предупреждение явно сообщает, что сбой произошёл только на стадии создания снимка, поэтому администраторы могут устранить проблему без остановки шарда.
